<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ã–zel Anonim Sohbet (DM, ArkadaÅŸlar)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { font-family: sans-serif; background:#1f2937; display:flex; justify-content:center; align-items:center; height:100vh; margin:0; }
#app { height: 100vh; max-height: 900px; }
#chat-area::-webkit-scrollbar, #inbox-list::-webkit-scrollbar, #messages-container::-webkit-scrollbar { width: 8px; }
#chat-area::-webkit-scrollbar-thumb, #inbox-list::-webkit-scrollbar-thumb, #messages-container::-webkit-scrollbar-thumb { background:#4b5563; border-radius:4px; }
#chat-area::-webkit-scrollbar-track, #inbox-list::-webkit-scrollbar-track, #messages-container::-webkit-scrollbar-track { background:#1f2937; }
</style>
</head>
<body>
<div id="app" class="w-full max-w-4xl flex flex-col sm:flex-row bg-gray-800 text-gray-100 rounded-xl shadow-2xl overflow-hidden">
    <div id="inbox-panel" class="w-full sm:w-1/3 p-4 border-r border-gray-700 flex flex-col max-h-full overflow-y-auto">
        <h2 class="text-xl font-bold mb-4 text-indigo-400">DM Kutusu / ArkadaÅŸlar</h2>
        
        <div id="request-badge" class="mb-4 p-3 bg-yellow-600/30 text-yellow-300 rounded-lg cursor-pointer hidden">
            Yeni ArkadaÅŸlÄ±k Ä°stekleri (<span id="request-count">0</span>)
        </div>

        <input type="text" id="user-search" placeholder="Nick ile kullanÄ±cÄ± ara..." class="p-2 mb-3 rounded-lg bg-gray-700 border border-gray-600 focus:border-indigo-500 text-white">
        
        <div id="inbox-list" class="flex-grow space-y-2 overflow-y-auto">
            </div>

        <button id="show-all-users" class="mt-4 p-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-sm">TÃ¼m KullanÄ±cÄ±larÄ± GÃ¶ster</button>
    </div>

    <div id="chat-area" class="w-full sm:w-2/3 flex flex-col p-4">
        <header id="chat-header" class="p-3 bg-gray-700 rounded-lg mb-4 hidden">
            <h3 class="text-xl font-bold text-white">Sohbet: <span id="chat-target-name"></span></h3>
        </header>

        <div id="messages-container" class="flex-grow space-y-4 overflow-y-auto p-2 mb-4 bg-gray-700 rounded-lg">
            <div id="initial-message" class="text-center text-gray-400 mt-10">
                Bir sohbete baÅŸlamak iÃ§in soldan bir kullanÄ±cÄ± seÃ§in.
            </div>
        </div>

        <div class="p-2 bg-gray-700 rounded-b-xl">
            <form id="message-form" class="flex space-x-2">
                <input type="text" id="message-input" placeholder="Bir mesaj yazÄ±n..." required 
                       class="flex-grow p-3 rounded-lg border-2 border-gray-600 focus:border-indigo-500 bg-gray-600 text-white placeholder-gray-400" disabled>
                <button type="submit" id="send-button" 
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-5 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    GÃ¶nder
                </button>
            </form>
        </div>
        
        <footer class="mt-4 text-sm text-center text-indigo-300 border-t border-gray-700 pt-2">
            <div id="user-info">GiriÅŸ yapÄ±lÄ±yor...</div>
        </footer>
    </div>
</div>

<div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden">
    <div class="bg-gray-800 rounded-xl p-6 w-11/12 md:w-1/2 shadow-2xl">
        <h3 id="modal-title" class="text-2xl font-bold mb-4 text-indigo-400"></h3>
        <div id="modal-content" class="max-h-96 overflow-y-auto space-y-3">
            </div>
        <button id="modal-close" class="mt-4 p-2 bg-gray-600 hover:bg-gray-500 rounded-lg w-full">Kapat</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, setDoc, getDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

// ðŸ”¥ KENDÄ° AYARLARINIZLA DEÄžÄ°ÅžTÄ°RÄ°N
const firebaseConfig = {
    apiKey: "AIzaSyA1pgPPENrAn_5hOt-Uy1qi2-qTejS_tFg",
    authDomain: "rebachat-fe0b8.firebaseapp.com",
    projectId: "rebachat-fe0b8",
    storageBucket: "rebachat-fe0b8.appspot.com",
    messagingSenderId: "1001689105465",
    appId: "1:1001689105465:web:932cf8cd83eae81adb39e8"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUserId = null;
let currentUserName = localStorage.getItem('nick') || null;
let activeChatId = null;
let activeChatTarget = null;
let unsubscribeMessages = null; // Aktif mesaj dinleyicisini tutar

// DOM Elementleri
const messagesContainer = document.getElementById('messages-container');
const messageForm = document.getElementById('message-form');
const messageInput = document.getElementById('message-input');
const sendButton = document.getElementById('send-button');
const userInfoDiv = document.getElementById('user-info');
const chatHeader = document.getElementById('chat-header');
const chatTargetName = document.getElementById('chat-target-name');
const inboxList = document.getElementById('inbox-list');
const requestBadge = document.getElementById('request-badge');
const requestCount = document.getElementById('request-count');
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modal-title');
const modalContent = document.getElementById('modal-content');
const modalClose = document.getElementById('modal-close');
const userSearchInput = document.getElementById('user-search');
const showAllUsersButton = document.getElementById('show-all-users');

// --- UTILITY FONKSÄ°YONLARI ---

/** Ä°ki ID'den DM ID'si oluÅŸturur (sÄ±ralÄ±). */
function getDmId(id1, id2) {
    return [id1, id2].sort().join('_');
}

function scrollToBottom(){ messagesContainer.scrollTop = messagesContainer.scrollHeight; }

function openModal(title, contentHtml) {
    modalTitle.textContent = title;
    modalContent.innerHTML = contentHtml;
    modal.classList.remove('hidden');
}

function closeModal() {
    modal.classList.add('hidden');
    // EÄŸer tÃ¼m kullanÄ±cÄ±lar listesi aÃ§Ä±ksa, arama Ã§ubuÄŸunu temizle
    if(userSearchInput.value) {
        userSearchInput.value = '';
        renderInboxAndFriends(); // TÃ¼m kullanÄ±cÄ± listesi kapandÄ±ktan sonra DM listesine geri dÃ¶n
    }
}

// --- ARABÄ°RÄ°M RENDER FONKSÄ°YONLARI ---

/** MesajÄ± ekrana Ã§izer. */
function renderMessage(message){
    if(!message.text) return '';
    const isCurrentUser = message.userId === currentUserId;
    const alignClass = isCurrentUser ? 'justify-end' : 'justify-start';
    const messageBg = isCurrentUser ? 'bg-indigo-600 text-white' : 'bg-gray-700 text-gray-100';
    const usernameText = message.username || 'Anonim';
    const formattedTime = message.createdAt ? new Date(message.createdAt.toDate()).toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'}) : 'Åžimdi';

    const messageHtml = `
    <div class="flex ${alignClass}">
        <div class="max-w-xs sm:max-w-md lg:max-w-lg">
            <div class="text-xs ${isCurrentUser?'text-right text-indigo-200':'text-left text-gray-400'} mb-1 font-semibold">
                ${isCurrentUser ? 'Siz' : usernameText}
            </div>
            <div class="px-4 py-2 rounded-xl ${messageBg} shadow-md break-words">
                ${message.text}
            </div>
            <div class="text-xs mt-1 ${isCurrentUser?'text-right':'text-left'} text-gray-400">
                ${formattedTime}
            </div>
        </div>
    </div>`;
    messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
}

// --- DM VE MESAJ DÄ°NLEYÄ°CÄ°LERÄ° ---

/** SeÃ§ili DM odasÄ±nÄ±n mesajlarÄ±nÄ± dinler. */
function setupMessageListener(dmId){
    // Ã–nceki dinleyiciyi sonlandÄ±r
    if (unsubscribeMessages) {
        unsubscribeMessages();
    }
    
    messagesContainer.innerHTML = '';
    document.getElementById('initial-message').classList.add('hidden');
    
    const q = query(collection(db, 'dms', dmId, 'messages'), orderBy('createdAt', 'asc'));
    
    unsubscribeMessages = onSnapshot(q, snapshot => {
        // YalnÄ±zca yeni mesajlarÄ± eklemek iÃ§in diff kontrolÃ¼ yapÄ±labilir,
        // ancak basitlik iÃ§in ÅŸimdilik her seferinde temizleyip yeniden Ã§iziyoruz.
        messagesContainer.innerHTML = ''; 
        snapshot.docs.forEach(doc => renderMessage(doc.data()));
        scrollToBottom();
    }, err => {
        console.error("DM mesajlarÄ± dinlenirken hata:", err);
    });
}

/** Sohbet odasÄ±nÄ± baÅŸlatÄ±r. */
function startChat(targetUser){
    if(activeChatTarget && activeChatTarget.uid === targetUser.uid) return; // Zaten bu sohbetteyiz

    activeChatTarget = targetUser;
    activeChatId = getDmId(currentUserId, targetUser.uid);

    // ArayÃ¼zÃ¼ gÃ¼ncelle
    chatTargetName.textContent = targetUser.username;
    chatHeader.classList.remove('hidden');
    messageInput.disabled = false;
    sendButton.disabled = false;

    // Mesaj dinleyicisini baÅŸlat
    setupMessageListener(activeChatId);
}

// --- ARKADAÅžLIK VE KULLANICI YÃ–NETÄ°MÄ° ---

/** ArkadaÅŸlÄ±k isteÄŸi gÃ¶nderir. */
async function sendFriendRequest(targetUserId, targetUsername){
    if(targetUserId === currentUserId) return;
    
    try {
        await setDoc(doc(db, 'friendRequests', getDmId(currentUserId, targetUserId)), {
            fromUserId: currentUserId,
            fromUsername: currentUserName,
            toUserId: targetUserId,
            toUsername: targetUsername,
            status: 'pending',
            createdAt: serverTimestamp()
        });
        alert(`ArkadaÅŸlÄ±k isteÄŸi ${targetUsername} kullanÄ±cÄ±sÄ±na gÃ¶nderildi.`);
        // ModalÄ± gÃ¼ncelle (eÄŸer aÃ§Ä±ksa)
        showAllUsers(); 
    } catch(err) {
        console.error("Ä°stek gÃ¶nderilemedi:", err);
        alert("Ä°stek gÃ¶nderilemedi.");
    }
}

/** ArkadaÅŸlÄ±k isteÄŸini kabul eder/reddeder. */
async function handleFriendRequest(requestId, status){
    try {
        await setDoc(doc(db, 'friendRequests', requestId), { status }, { merge: true });
        
        if (status === 'accepted') {
            const requestDoc = await getDoc(doc(db, 'friendRequests', requestId));
            const data = requestDoc.data();
            
            // KullanÄ±cÄ±larÄ±n arkadaÅŸ listesine ekle
            await setDoc(doc(db, 'users', data.fromUserId), { 
                friends: arrayUnion(data.toUserId) 
            }, { merge: true });
            
            await setDoc(doc(db, 'users', data.toUserId), { 
                friends: arrayUnion(data.fromUserId) 
            }, { merge: true });

            alert(`${data.fromUsername} artÄ±k arkadaÅŸÄ±nÄ±z.`);
        }
        
        // Modal iÃ§eriÄŸini ve sayacÄ± gÃ¼ncelle
        setupFriendRequestsListener(); 
        document.getElementById('request-badge').click(); // ModalÄ± yeniden aÃ§
    } catch(err) {
        console.error("Ä°stek iÅŸlenemedi:", err);
    }
}

/** ArkadaÅŸlÄ±k isteklerini dinler ve rozeti gÃ¼nceller. */
function setupFriendRequestsListener(){
    if(!currentUserId) return;
    
    // Gelen beklemedeki istekleri dinle
    const q = query(collection(db, 'friendRequests'), 
                    where('toUserId', '==', currentUserId), 
                    where('status', '==', 'pending'),
                    orderBy('createdAt', 'desc'));
    
    onSnapshot(q, snapshot => {
        const count = snapshot.size;
        requestCount.textContent = count;
        requestBadge.classList.toggle('hidden', count === 0);
        
        // Ä°stek listesini hazÄ±rlama (Modal aÃ§Ä±ldÄ±ÄŸÄ±nda kullanÄ±lacak)
        let requestsHtml = '<p class="text-gray-400">Yeni isteÄŸiniz yok.</p>';
        if (count > 0) {
            requestsHtml = snapshot.docs.map(doc => {
                const req = doc.data();
                return `
                <div class="flex justify-between items-center p-3 bg-gray-700 rounded-lg">
                    <span class="font-semibold">${req.fromUsername}</span>
                    <div>
                        <button onclick="handleFriendRequest('${doc.id}', 'accepted')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-lg text-sm mr-2">Kabul Et</button>
                        <button onclick="handleFriendRequest('${doc.id}', 'rejected')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-lg text-sm">Reddet</button>
                    </div>
                </div>`;
            }).join('');
        }
        requestBadge.onclick = () => openModal('Gelen ArkadaÅŸlÄ±k Ä°stekleri', requestsHtml);
    });
}

/** TÃ¼m kullanÄ±cÄ±larÄ± arar ve modalda gÃ¶sterir. */
async function showAllUsers(searchTerm = ''){
    const q = query(collection(db, 'users'), orderBy('username'));
    const snapshot = await getDocs(q);
    
    let userHtml = '';
    snapshot.forEach(doc => {
        const user = doc.data();
        if (user.uid === currentUserId) return; // Kendimizi listeleme
        if (searchTerm && !user.username.toLowerCase().includes(searchTerm.toLowerCase())) return;

        userHtml += `
        <div class="flex justify-between items-center p-3 bg-gray-700 rounded-lg">
            <span class="font-semibold">${user.username}</span>
            <button onclick="sendFriendRequest('${user.uid}', '${user.username}')" 
                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded-lg text-sm">
                ArkadaÅŸ Ekle
            </button>
        </div>`;
    });

    openModal('TÃ¼m KullanÄ±cÄ±lar', userHtml || '<p class="text-gray-400">KullanÄ±cÄ± bulunamadÄ±.</p>');
}

// --- INBOX VE DM LÄ°STESÄ° DÄ°NLEYÄ°CÄ°SÄ° ---

function renderInboxAndFriends() {
    if (!currentUserId) return;
    
    inboxList.innerHTML = '<p class="text-gray-400">YÃ¼kleniyor...</p>';
    
    // ðŸ”¥ Ã–NEMLÄ°: Bu dinleyici, kullanÄ±cÄ±nÄ±n DM'lerini ve arkadaÅŸlarÄ±nÄ± (varsa) gÃ¶stermelidir.
    // Basitlik adÄ±na, sadece kullanÄ±cÄ±yÄ± iÃ§eren tÃ¼m 'dms' koleksiyonunu dinliyoruz.
    const q1 = query(collection(db, 'dms'), where('user1', '==', currentUserId));
    const q2 = query(collection(db, 'dms'), where('user2', '==', currentUserId));
    
    // Ä°ki sorguyu birleÅŸtirmek zordur, bu yÃ¼zden geÃ§ici olarak sadece bir yÃ¶ndeki DM'leri dinleyelim.
    // GerÃ§ek uygulamada, kullanÄ±cÄ±larÄ±n arkadaÅŸ listesinden ve DM gÃ¼ncellemelerinden bir "inbox" listesi oluÅŸturulur.
    
    onSnapshot(q1, snapshot => {
        inboxList.innerHTML = '';
        if(snapshot.empty) {
            inboxList.innerHTML = '<p class="text-gray-400">HenÃ¼z bir DM sohbetiniz yok.</p>';
        }
        snapshot.forEach(doc => {
            const dm = doc.data();
            const targetId = dm.user1 === currentUserId ? dm.user2 : dm.user1;
            const targetName = dm.user1 === currentUserId ? dm.user2Name : dm.user1Name; // GerÃ§ek uygulamada bu isimler DM nesnesinde tutulur
            
            // SimÃ¼lasyon: Target user nesnesi oluÅŸtur
            const targetUser = { uid: targetId, username: targetName || 'Bilinmeyen KullanÄ±cÄ±' };

            const dmItem = document.createElement('div');
            dmItem.className = 'p-3 bg-gray-700 hover:bg-gray-600 rounded-lg cursor-pointer flex justify-between items-center';
            dmItem.innerHTML = `
                <span class="font-semibold">${targetUser.username}</span>
                <span class="text-xs text-gray-400">${dm.lastMessage || 'Sohbete BaÅŸla'}</span>
            `;
            dmItem.onclick = () => startChat(targetUser);
            inboxList.appendChild(dmItem);
        });
    });
}


// --- ANA MANTIK VE OLAY YÃ–NETÄ°CÄ°LERÄ° ---

messageForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const text = messageInput.value.trim();
    if(!text || !currentUserId || !activeChatId || !activeChatTarget) return;

    try{
        // 1. DM'nin alt koleksiyonuna mesajÄ± ekle
        await addDoc(collection(db, 'dms', activeChatId, 'messages'), {
            text,
            createdAt: serverTimestamp(),
            userId: currentUserId,
            username: currentUserName
        });
        
        // 2. DM nesnesini son mesaj ve zamanla gÃ¼ncelle (Inbox iÃ§in)
        await setDoc(doc(db, 'dms', activeChatId), {
            user1: currentUserId,
            user2: activeChatTarget.uid,
            // GerÃ§ek uygulamada user1Name ve user2Name'i de eklemek gerekir
            lastMessage: text,
            updatedAt: serverTimestamp()
        }, { merge: true });

        messageInput.value='';
        scrollToBottom();
    }catch(err){
        console.error("Mesaj gÃ¶nderilemedi:",err);
    }
});

userSearchInput.addEventListener('input', (e) => showAllUsers(e.target.value));
showAllUsersButton.addEventListener('click', () => showAllUsers());
modalClose.addEventListener('click', closeModal);

// --- BAÅžLANGIÃ‡ MANTIÄžI (AUTH) ---

signInAnonymously(auth).catch(err => console.error("Anonim GiriÅŸ HatasÄ±:", err));

onAuthStateChanged(auth, async user => {
    if(user){
        currentUserId = user.uid;
        let nick = localStorage.getItem('nick');
        
        // KullanÄ±cÄ± AdÄ± Belirleme ve VeritabanÄ±na KayÄ±t
        if(!nick){
            nick = prompt("HoÅŸgeldiniz! LÃ¼tfen bir Nick (KullanÄ±cÄ± AdÄ±) belirleyin:") || "Anonim";
            localStorage.setItem('nick', nick);
            
            // ðŸ”¥ YENÄ°: KullanÄ±cÄ±yÄ± 'users' koleksiyonuna kaydet
            await setDoc(doc(db, "users", currentUserId), {
                username: nick,
                uid: currentUserId,
                friends: [], // BaÅŸlangÄ±Ã§ta boÅŸ arkadaÅŸ listesi
                blocked: [], // BaÅŸlangÄ±Ã§ta boÅŸ engellenenler listesi
                createdAt: serverTimestamp()
            });
            currentUserName = nick;
        } else {
             // KayÄ±tlÄ± nick'i kullanarak kullanÄ±cÄ±nÄ±n mevcut verilerini getir/gÃ¼ncelle
             const userDoc = await getDoc(doc(db, "users", currentUserId));
             if(userDoc.exists()) {
                 currentUserName = userDoc.data().username;
             } else {
                 // EÄŸer localStorage'da nick varsa ama DB'de yoksa, DB'ye kaydet
                 await setDoc(doc(db, "users", currentUserId), {
                     username: nick,
                     uid: currentUserId,
                     friends: [],
                     blocked: [],
                     createdAt: serverTimestamp()
                 });
                 currentUserName = nick;
             }
        }
        
        userInfoDiv.innerHTML = `HoÅŸgeldiniz, <strong>${currentUserName}</strong>`;
        
        // Dinleyicileri BaÅŸlat
        setupFriendRequestsListener(); 
        renderInboxAndFriends(); // DM Kutusu/ArkadaÅŸlar listesini getir
        
    } else {
        userInfoDiv.innerHTML = `GiriÅŸ yapÄ±lamadÄ±.`;
        messageInput.disabled = true;
        sendButton.disabled = true;
    }
});

// Global scope'a ekliyoruz ki, HTML'deki inline onclick fonksiyonlarÄ± Ã§alÄ±ÅŸabilsin
window.handleFriendRequest = handleFriendRequest;

// Ä°htiyacÄ±nÄ±z olursa setDoc, getDoc ve arrayUnion'Ä± global yapÄ±n
import { getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
window.getDocs = getDocs;

import { arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
window.arrayUnion = arrayUnion;

</script>
</body>
</html>
