<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerçek Zamanlı Sohbet Uygulaması</title>
    <!-- Tailwind CSS Yükleniyor -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font Yükleniyor -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937; /* Koyu Gri Arka Plan */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        /* Sohbete özel kaydırma çubuğu stili */
        #messages-container::-webkit-scrollbar {
            width: 8px;
        }
        #messages-container::-webkit-scrollbar-thumb {
            background-color: #4b5563; /* Koyu çubuk */
            border-radius: 4px;
        }
        #messages-container::-webkit-scrollbar-track {
            background: #1f2937; /* Kaydırma alanı arka planı */
        }
    </style>
</head>
<body>

    <div id="app-container" class="w-full max-w-lg h-full sm:h-[90vh] sm:rounded-xl shadow-2xl flex flex-col bg-gray-800 text-gray-100">

        <!-- Başlık ve Kullanıcı Bilgisi -->
        <header class="p-4 bg-indigo-600 rounded-t-xl sm:rounded-t-xl shadow-lg">
            <h1 class="text-2xl font-bold">Gemini Sohbet Odası</h1>
            <div id="user-info" class="text-sm mt-1 text-indigo-200">Bağlanılıyor...</div>
        </header>

        <!-- Mesaj Alanı -->
        <div id="messages-container" class="flex-grow p-4 space-y-4 overflow-y-auto">
            <!-- Mesajlar buraya yüklenecek -->
        </div>

        <!-- Yükleniyor/Hata Alanı -->
        <div id="status-message" class="p-4 text-center text-yellow-400 hidden">Bağlanılıyor...</div>
        
        <!-- Mesaj Gönderme Formu -->
        <div class="p-4 bg-gray-700 sm:rounded-b-xl shadow-inner">
            <form id="message-form" class="flex space-x-2">
                <input
                    type="text"
                    id="message-input"
                    placeholder="Bir mesaj yazın..."
                    autocomplete="off"
                    required
                    class="flex-grow p-3 rounded-lg border-2 border-gray-600 focus:border-indigo-500 bg-gray-600 text-white placeholder-gray-400 transition duration-300"
                >
                <button
                    type="submit"
                    id="send-button"
                    disabled
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-5 rounded-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed shadow-md hover:shadow-lg"
                >
                    Gönder
                </button>
            </form>
        </div>
    </div>

    <!-- Firebase SDK'ları -->
    <script type="module">
        // Firebase Modüllerini İçe Aktar
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firestore ve Auth Referansları
        let db;
        let auth;
        let currentUserId = null;
        let isAuthReady = false;

        // UI Elementleri
        const messagesContainer = document.getElementById('messages-container');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const userInfoDiv = document.getElementById('user-info');
        const statusMessageDiv = document.getElementById('status-message');

        // Firestore işlemlerinden önce kimlik doğrulamanın hazır olmasını sağlamak için
        setLogLevel('debug'); // Hata ayıklama için günlüklemeyi etkinleştir

        // Ortam değişkenlerini al ve fallback sağla
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-chat-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firestore Yolunu Tanımla (Genel/Public Veri)
        // Yolu /artifacts/{appId}/public/data/messages olarak ayarlıyoruz
        const getCollectionRef = () => {
            const collectionPath = `/artifacts/${appId}/public/data/messages`;
            return collection(db, collectionPath);
        };

        /**
         * Mesajları ekranda göstermek için HTML oluşturur.
         * @param {Object} message - Firestore mesaj nesnesi.
         * @param {string} userId - Mevcut kullanıcının ID'si.
         */
        function renderMessage(message, userId) {
            if (!message.text) return '';

            const isCurrentUser = message.userId === userId;
            const alignClass = isCurrentUser ? 'justify-end' : 'justify-start';
            const messageBg = isCurrentUser ? 'bg-indigo-600 text-white' : 'bg-gray-700 text-gray-100';
            const usernameText = message.username || 'Anonim Kullanıcı';

            const formattedTime = message.createdAt ? new Date(message.createdAt.toDate()).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }) : 'Şimdi';

            const messageHtml = `
                <div class="flex ${alignClass}">
                    <div class="max-w-xs sm:max-w-md lg:max-w-lg">
                        <div class="text-xs ${isCurrentUser ? 'text-right text-indigo-200' : 'text-left text-gray-400'} mb-1 font-semibold">
                            ${isCurrentUser ? 'Siz' : usernameText}
                        </div>
                        <div class="px-4 py-2 rounded-xl ${messageBg} shadow-md break-words">
                            ${message.text}
                        </div>
                        <div class="text-xs mt-1 ${isCurrentUser ? 'text-right' : 'text-left'} text-gray-400">
                            ${formattedTime}
                        </div>
                    </div>
                </div>
            `;
            messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
        }

        /**
         * Mesaj listesini en alta kaydırır.
         */
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        /**
         * Tüm mesajları yükler ve gerçek zamanlı dinleyiciyi kurar.
         */
        function setupMessageListener() {
            if (!db || !isAuthReady) return;

            const q = query(getCollectionRef(), orderBy('createdAt', 'asc'));

            // Gerçek zamanlı dinleyiciyi başlat
            onSnapshot(q, (snapshot) => {
                const isScrollNeeded = messagesContainer.scrollHeight - messagesContainer.scrollTop - messagesContainer.clientHeight < 50;
                let hasNewMessages = false;

                snapshot.docChanges().forEach((change) => {
                    const message = change.doc.data();
                    // Firestore'un kendi ID'si, mesajın tekrar yüklenmesini önler
                    message.id = change.doc.id; 
                    
                    if (change.type === 'added') {
                        // Yalnızca yeni eklenen mesajları oluştur
                        renderMessage(message, currentUserId);
                        hasNewMessages = true;
                    }
                    // Diğer durumlar (modified/removed) basit bir sohbet uygulamasında nadiren kullanılır.
                });

                // Yalnızca yeni mesajlar varsa veya zaten alttaysa kaydır
                if (hasNewMessages || isScrollNeeded) {
                     // Yeni mesajlar geldikten sonra bir sonraki frame'de kaydır
                    requestAnimationFrame(scrollToBottom);
                }
            }, (error) => {
                console.error("Mesaj dinlenirken hata oluştu:", error);
                statusMessageDiv.textContent = 'Mesajlar yüklenemedi. Hata: ' + error.message;
                statusMessageDiv.classList.remove('hidden');
            });
        }

        /**
         * Yeni mesaj gönderir.
         */
        async function sendMessage(e) {
            e.preventDefault();
            const text = messageInput.value.trim();

            if (!text || !currentUserId || !db) return;

            try {
                // Kullanıcı ID'sinin ilk 8 karakterini kullanıcı adı olarak kullan
                const displayName = currentUserId.substring(0, 8);
                
                await addDoc(getCollectionRef(), {
                    text: text,
                    createdAt: serverTimestamp(),
                    userId: currentUserId,
                    username: displayName,
                    // Diğer kullanıcıların bu ID'yi görmesi için 
                    fullUserId: currentUserId
                });

                messageInput.value = ''; // Input'u temizle
                scrollToBottom(); // Mesajı gönderdikten sonra hemen kaydır
            } catch (error) {
                console.error("Mesaj gönderilirken hata oluştu: ", error);
                statusMessageDiv.textContent = 'Mesaj gönderilemedi. Hata: ' + error.message;
                statusMessageDiv.classList.remove('hidden');
            }
        }

        /**
         * Firebase'i başlatır ve kimlik doğrulamayı yapar.
         */
        async function initializeAndAuthenticate() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                     statusMessageDiv.textContent = 'HATA: Firebase yapılandırması yüklenemedi.';
                     statusMessageDiv.classList.remove('hidden');
                     return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Kimlik doğrulama durumunu dinle
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        isAuthReady = true;
                        userInfoDiv.innerHTML = `Kullanıcı ID'niz: <strong class="text-indigo-100">${currentUserId}</strong>`;
                        sendButton.disabled = false;
                        statusMessageDiv.classList.add('hidden');
                        
                        // Kimlik doğrulama başarılı olduktan sonra mesaj dinleyicisini kur
                        setupMessageListener();

                    } else {
                        // Kullanıcı oturumu kapattıysa veya başarısız olduysa
                        currentUserId = null;
                        isAuthReady = false;
                        userInfoDiv.textContent = 'Oturum Açılamadı.';
                        sendButton.disabled = true;
                    }
                });

                // Ortam değişkeninden sağlanan özel token ile oturum açmayı dene
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Token yoksa anonim olarak oturum aç
                    await signInAnonymously(auth);
                }
                
            } catch (error) {
                console.error("Firebase başlatılırken veya oturum açılırken hata oluştu:", error);
                userInfoDiv.textContent = `Hata: ${error.message}`;
                statusMessageDiv.textContent = 'Uygulama başlatılamadı. Lütfen konsolu kontrol edin.';
                statusMessageDiv.classList.remove('hidden');
            }
        }

        // Event listener'ları ata
        messageForm.addEventListener('submit', sendMessage);

        // Uygulamayı başlat
        initializeAndAuthenticate();

    </script>
</body>
</html>