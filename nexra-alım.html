<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nexra Yetkili Alım Sistemi</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body { font-family:'Inter',sans-serif; background-color:#1f2937; color:#f3f4f6; min-height:100vh; display:flex; flex-direction:column; }
.card { background-color:#374151; border-radius:1rem; box-shadow:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6 -2 rgba(0,0,0,0.05); transition:all 0.3s ease; }
.btn-primary { background-color:#4f46e5; color:white; padding:0.75rem 1.5rem; border-radius:0.5rem; font-weight:600; transition:background-color 0.2s; }
.btn-primary:hover { background-color:#6366f1; }
input,textarea,select { background-color:#4b5563; border:1px solid #6b7280; color:#f3f4f6; border-radius:0.5rem; padding:0.5rem; width:100%; }
input:focus,textarea:focus { border-color:#4f46e5; outline:none; }
</style>
</head>
<body class="p-4 sm:p-8">
<header class="text-center mb-8">
<h1 class="text-4xl font-extrabold text-white tracking-tight">Nexra Yetkili Alımı</h1>
<p id="auth-status" class="text-sm mt-2 text-gray-400"></p>
</header>

<div class="max-w-6xl w-full mx-auto flex-grow">
<div id="recruitment-status-banner" class="card p-4 mb-8 text-center hidden">
<p id="recruitment-status-text" class="text-xl font-bold"></p>
</div>

<div id="admin-switch" class="flex justify-end mb-4 hidden">
<button id="toggle-admin-panel" class="btn-primary text-sm p-2">Admin Panelini Aç</button>
</div>

<div id="content-area"></div>
<div id="loading-indicator" class="text-center p-10 text-xl hidden"><p>Sistem yükleniyor, lütfen bekleyin...</p></div>
</div>

<div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
<div class="card p-6 m-4 w-full max-w-md">
<h3 id="modal-title" class="text-xl font-semibold mb-4 text-white"></h3>
<p id="modal-message" class="text-gray-300 mb-6"></p>
<div class="flex justify-end space-x-3">
<button id="modal-cancel" class="px-4 py-2 text-gray-300 rounded-lg hover:bg-gray-600 hidden">İptal</button>
<button id="modal-ok" class="btn-primary">Tamam</button>
</div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, collection, query, where, onSnapshot, addDoc, updateDoc, getDocs, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

let app, db, auth;
let userId=null, isRecruitmentOpen=false, isAdmin=false, applications=[], currentView='apply';
const appId='default-app-id';

const authStatusEl=document.getElementById('auth-status');
const contentAreaEl=document.getElementById('content-area');
const loadingIndicatorEl=document.getElementById('loading-indicator');
const recruitmentStatusBannerEl=document.getElementById('recruitment-status-banner');
const recruitmentStatusTextEl=document.getElementById('recruitment-status-text');
const adminSwitchEl=document.getElementById('admin-switch');
const toggleAdminPanelBtn=document.getElementById('toggle-admin-panel');

const firebaseConfig = {
  apiKey: "AIzaSyBKdbwP6hT4D9y1pjF7Ew5fm8CjDDqk-G0",
  authDomain: "nexra-67f1a.firebaseapp.com",
  projectId: "nexra-67f1a",
  storageBucket: "nexra-67f1a.firebasestorage.app",
  messagingSenderId: "27569499287",
  appId: "1:27569499287:web:454dee7512dc41eb498dd2",
  measurementId: "G-FM78L8VCVX"
};

function showModal(title,message){
    const modal=document.getElementById('custom-modal');
    document.getElementById('modal-title').textContent=title;
    document.getElementById('modal-message').textContent=message;
    modal.classList.remove('opacity-0','pointer-events-none');
    document.getElementById('modal-ok').onclick=()=>modal.classList.add('opacity-0','pointer-events-none');
}

function showLoading(state){ loadingIndicatorEl.style.display=state?'block':'none'; }

app=initializeApp(firebaseConfig);
db=getFirestore(app);
auth=getAuth(app);
setLogLevel('Debug');

async function initAuth(){
    showLoading(true);
    try{
        await signInAnonymously(auth);
        onAuthStateChanged(auth,user=>{
            if(user){
                userId=user.uid;
                console.log("Auth başarılı, userId:",userId);
                authStatusEl.innerHTML=`Hoş geldiniz! Kullanıcı ID'niz: <span class="font-mono text-indigo-400 break-all">${userId}</span>`;
                initializeListeners();
            }
        });
    }catch(e){console.error(e);showModal("Hata","Giriş yapılamadı.");}
}

// Firestore collection path
const CONFIG_DOC=()=>doc(db,'nexra_config','status');
const APPLICATIONS_COLLECTION=()=>collection(db,'nexra_applications');

function initializeListeners(){
    listenToConfig();
    listenToApplications();
    toggleAdminPanelBtn.addEventListener('click',()=>{
        currentView=currentView==='apply'?'admin_panel':'apply';
        renderApp();
    });
}

function listenToConfig(){
    onSnapshot(CONFIG_DOC(),async docSnap=>{
        let config;
        if(docSnap.exists()){ 
            config=docSnap.data();
            console.log("Config geldi:",config);
        } else {
            config={ recruitmentOpen:true, admins:[userId] };
            try{
                await setDoc(CONFIG_DOC(),config,{merge:true});
                console.log("Config oluşturuldu.");
            }catch(e){console.error("Config yazılamadı:",e);}
        }
        isRecruitmentOpen=config.recruitmentOpen||false;
        isAdmin=config.admins?.includes(userId)||false;
        updateRecruitmentBanner(isRecruitmentOpen);
        renderApp();
    });
}

function listenToApplications(){
    onSnapshot(query(APPLICATIONS_COLLECTION()),snapshot=>{
        applications=[];
        snapshot.forEach(doc=>applications.push({id:doc.id,...doc.data()}));
        applications.sort((a,b)=>(b.timestamp?.seconds||0)-(a.timestamp?.seconds||0));
        if(currentView==='admin_panel') renderAdminPanel();
        showLoading(false);
    });
}

// ... renderApp, renderApplicationForm, renderAdminPanel, updateApplicationStatus fonksiyonları aynı

initAuth();
</script>
</body>
</html>