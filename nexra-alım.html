<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nexra Yetkili AlÄ±m Sistemi</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body { font-family:'Inter',sans-serif; background-color:#1f2937; color:#f3f4f6; min-height:100vh; display:flex; flex-direction:column; }
.card { background-color:#374151; border-radius:1rem; box-shadow:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2 rgba(0,0,0,0.05); transition:all 0.3s ease; }
.btn-primary { background-color:#4f46e5; color:white; padding:0.75rem 1.5rem; border-radius:0.5rem; font-weight:600; transition:background-color 0.2s; }
.btn-primary:hover { background-color:#6366f1; }
input,textarea,select { background-color:#4b5563; border:1px solid #6b7280; color:#f3f4f6; border-radius:0.5rem; padding:0.5rem; width:100%; }
input:focus,textarea:focus { border-color:#4f46e5; outline:none; }
</style>
</head>
<body class="p-4 sm:p-8">

<header class="text-center mb-8">
<h1 class="text-4xl font-extrabold text-white tracking-tight">Nexra Yetkili AlÄ±mÄ±</h1>
<p id="auth-status" class="text-sm mt-2 text-gray-400"></p>
</header>

<div class="max-w-6xl w-full mx-auto flex-grow">
<div id="recruitment-status-banner" class="card p-4 mb-8 text-center hidden">
<p id="recruitment-status-text" class="text-xl font-bold"></p>
</div>

<div id="admin-switch" class="flex justify-end mb-4 hidden">
<button id="toggle-admin-panel" class="btn-primary text-sm p-2">Admin Panelini AÃ§</button>
</div>

<div id="content-area"></div>
<div id="loading-indicator" class="text-center p-10 text-xl hidden"><p>Sistem yÃ¼kleniyor, lÃ¼tfen bekleyin...</p></div>
</div>

<div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
<div class="card p-6 m-4 w-full max-w-md">
<h3 id="modal-title" class="text-xl font-semibold mb-4 text-white"></h3>
<p id="modal-message" class="text-gray-300 mb-6"></p>
<div class="flex justify-end space-x-3">
<button id="modal-cancel" class="px-4 py-2 text-gray-300 rounded-lg hover:bg-gray-600 hidden">Ä°ptal</button>
<button id="modal-ok" class="btn-primary">Tamam</button>
</div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, collection, query, where, onSnapshot, addDoc, updateDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

let app, db, auth;
let userId=null, isRecruitmentOpen=false, isAdmin=false, applications=[], currentView='apply';
const appId='default-app-id';

const authStatusEl=document.getElementById('auth-status');
const contentAreaEl=document.getElementById('content-area');
const loadingIndicatorEl=document.getElementById('loading-indicator');
const recruitmentStatusBannerEl=document.getElementById('recruitment-status-banner');
const recruitmentStatusTextEl=document.getElementById('recruitment-status-text');
const adminSwitchEl=document.getElementById('admin-switch');
const toggleAdminPanelBtn=document.getElementById('toggle-admin-panel');

const firebaseConfig = {
    apiKey: "AIzaSyBKdbwP6hT4D9y1pjF7Ew5fm8CjDDqk-G0",
    authDomain: "nexra-67f1a.firebaseapp.com",
    projectId: "nexra-67f1a",
    storageBucket: "nexra-67f1a.appspot.com",
    messagingSenderId: "27569499287",
    appId: "1:27569499287:web:454dee7512dc41eb498dd2"
};

function showModal(title,message){
    const modal=document.getElementById('custom-modal');
    document.getElementById('modal-title').textContent=title;
    document.getElementById('modal-message').textContent=message;
    modal.classList.remove('opacity-0','pointer-events-none');
    document.getElementById('modal-ok').onclick=()=>modal.classList.add('opacity-0','pointer-events-none');
}

function showLoading(state){ loadingIndicatorEl.style.display=state?'block':'none'; }

app=initializeApp(firebaseConfig);
db=getFirestore(app);
auth=getAuth(app);
setLogLevel('Debug');

async function initAuth(){
    showLoading(true);
    try{
        await signInAnonymously(auth);
        onAuthStateChanged(auth,user=>{
            if(user){
                userId=user.uid;
                authStatusEl.innerHTML=`HoÅŸ geldiniz! KullanÄ±cÄ± ID'niz: <span class="font-mono text-indigo-400 break-all">${userId}</span>`;
                initializeListeners();
            }
        });
    }catch(e){console.error(e);showModal("Hata","GiriÅŸ yapÄ±lamadÄ±.");}
}

const BASE_PATH=(collectionName)=>`artifacts/${appId}/public/data/${collectionName}`;
const CONFIG_DOC_PATH=()=>doc(db,BASE_PATH('nexra_config'),'status');
const APPLICATIONS_COLLECTION=()=>collection(db,BASE_PATH('nexra_applications'));

function initializeListeners(){
    listenToConfig();
    listenToApplications();
    toggleAdminPanelBtn.addEventListener('click',()=>{
        currentView=currentView==='apply'?'admin_panel':'apply';
        renderApp();
    });
}

function listenToConfig(){
    onSnapshot(CONFIG_DOC_PATH(),async docSnap=>{
        let config;
        if(docSnap.exists()){ config=docSnap.data(); }
        else{
            config={ recruitmentOpen:true, admins:[userId] };
            await setDoc(CONFIG_DOC_PATH(),config,{merge:true});
        }
        isRecruitmentOpen=config.recruitmentOpen||false;
        isAdmin=config.admins?.includes(userId)||false;
        updateRecruitmentBanner(isRecruitmentOpen);
        renderApp();
    });
}

function listenToApplications(){
    onSnapshot(query(APPLICATIONS_COLLECTION()),snapshot=>{
        applications=[];
        snapshot.forEach(doc=>applications.push({id:doc.id,...doc.data()}));
        applications.sort((a,b)=>(b.timestamp?.seconds||0)-(a.timestamp?.seconds||0));
        if(currentView==='admin_panel') renderAdminPanel();
        showLoading(false);
    });
}

function updateRecruitmentBanner(isOpen){
    recruitmentStatusBannerEl.style.display='block';
    recruitmentStatusTextEl.textContent=isOpen?"âœ… Yetkili AlÄ±mÄ± AÃ‡IK!":"ğŸ›‘ Yetkili AlÄ±mÄ± KAPALI.";
    recruitmentStatusBannerEl.className=`card p-4 mb-8 text-center ${isOpen?'bg-green-700/50 border-green-500':'bg-red-700/50 border-red-500'} border`;
}

function renderApp(){
    if(isAdmin){
        adminSwitchEl.style.display='flex';
        toggleAdminPanelBtn.textContent=currentView==='admin_panel'?'BaÅŸvuru Formuna DÃ¶n':'Admin Panelini AÃ§';
    }else adminSwitchEl.style.display='none';
    currentView==='admin_panel'&&isAdmin?renderAdminPanel():renderApplicationForm();
}

function renderApplicationForm(){
    const appData=applications.find(app=>app.applicantId===userId);
    if(appData){
        let statusColor='bg-yellow-600';
        if(appData.status==='Approved') statusColor='bg-green-600';
        else if(appData.status==='Rejected') statusColor='bg-red-600';
        contentAreaEl.innerHTML=`
        <div class="card p-8 sm:p-10 max-w-3xl mx-auto shadow-xl hover:shadow-2xl transition-all duration-300 ${statusColor}/20 border ${statusColor} border-opacity-50">
            <h2 class="text-3xl font-extrabold mb-4 text-white">BaÅŸvuru Durumunuz</h2>
            <p class="text-lg text-gray-200 mb-2"><span class="font-semibold">Ad / KullanÄ±cÄ±:</span> ${appData.name}</p>
            <p class="text-lg text-gray-200 mb-2"><span class="font-semibold">YaÅŸ:</span> ${appData.age}</p>
            <p class="text-lg text-gray-200 mb-2"><span class="font-semibold">Durum:</span> ${appData.status}</p>
            <p class="text-lg text-gray-200 mb-2"><span class="font-semibold">Reddedilme Nedeni:</span> ${appData.rejectionReason||'â€”'}</p>
            <p class="text-lg text-gray-200 mb-2"><span class="font-semibold">BaÅŸvurma Tarihi:</span> ${new Date(appData.timestamp?.seconds*1000).toLocaleString('tr-TR')}</p>
            <p class="text-lg text-gray-200 mb-2"><span class="font-semibold">Cevap Tarihi:</span> ${appData.responseTimestamp?new Date(appData.responseTimestamp.seconds*1000).toLocaleString('tr-TR'):'â€”'}</p>
            <p class="text-lg text-gray-200 mb-2"><span class="font-semibold">Deneyim:</span> ${appData.experience}</p>
            <p class="text-lg text-gray-200 mb-2"><span class="font-semibold">Motivasyon:</span> ${appData.motivation}</p>
            <p class="text-lg text-gray-200 mb-2"><span class="font-semibold">Kavga Ã‡Ã¶zÃ¼mÃ¼:</span> ${appData.conflictResolution}</p>
            <p class="text-lg text-gray-200 mb-2"><span class="font-semibold">Yetkili Sorunu:</span> ${appData.authorityIssue}</p>
            <p class="text-lg text-gray-200 mb-2"><span class="font-semibold">Ã‡Ä±kar Ã‡atÄ±ÅŸmasÄ±:</span> ${appData.conflictOfInterest}</p>
        </div>`;
        return;
    }

    contentAreaEl.innerHTML=`
    <div class="card p-8 sm:p-10 max-w-3xl mx-auto shadow-xl hover:shadow-2xl transition-all duration-300">
        <h2 class="text-3xl font-extrabold mb-6 text-indigo-400">Yetkili AlÄ±m BaÅŸvuru Formu</h2>
        <form id="application-form" class="space-y-6">
            <div><label>AdÄ±nÄ±z / KullanÄ±cÄ± AdÄ±nÄ±z:</label><input type="text" id="name" name="name" required placeholder="AdÄ±nÄ±z ve kullanÄ±cÄ± adÄ±nÄ±z"></div>
            <div><label>YaÅŸÄ±nÄ±z:</label><input type="number" id="age" name="age" required placeholder="YaÅŸÄ±nÄ±z" min="12" max="100"></div>
            <div><label>Deneyimleriniz:</label><textarea id="experience" name="experience" rows="4" required></textarea></div>
            <div><label>Motivasyon:</label><textarea id="motivation" name="motivation" rows="4" required></textarea></div>
            <div><label>Kavga Ã‡Ã¶zÃ¼mÃ¼:</label><textarea id="conflict-resolution" name="conflict-resolution" rows="3" required></textarea></div>
            <div><label>Yetkili Sorunu:</label><textarea id="authority-issue" name="authority-issue" rows="3" required></textarea></div>
            <div><label>Ã‡Ä±kar Ã‡atÄ±ÅŸmasÄ±:</label><textarea id="conflict-of-interest" name="conflict-of-interest" rows="3" required></textarea></div>
            <button type="submit" class="btn-primary w-full py-3 font-semibold text-lg hover:bg-indigo-500 transition-colors">BaÅŸvuruyu GÃ¶nder</button>
        </form>
    </div>`;

    document.getElementById('application-form').addEventListener('submit',async e=>{
        e.preventDefault();
        if(!isRecruitmentOpen) return showModal("UyarÄ±","Åu anda yetkili alÄ±mÄ± kapalÄ±dÄ±r.");
        const form=e.target;
        const data={
            applicantId:userId,
            name:form.name.value.trim(),
            age:parseInt(form.age.value.trim()),
            experience:form.experience.value.trim(),
            motivation:form.motivation.value.trim(),
            conflictResolution:form['conflict-resolution'].value.trim(),
            authorityIssue:form['authority-issue'].value.trim(),
            conflictOfInterest:form['conflict-of-interest'].value.trim(),
            status:'Pending',
            timestamp:serverTimestamp()
        };
        try{
            const existingQuery=query(APPLICATIONS_COLLECTION(),where("applicantId","==",userId));
            const existingSnapshot=await getDocs(existingQuery);
            if(!existingSnapshot.empty){
                await updateDoc(doc(db,APPLICATIONS_COLLECTION().path,existingSnapshot.docs[0].id),data);
            }else await addDoc(APPLICATIONS_COLLECTION(),data);
            showModal("BaÅŸarÄ±lÄ±","BaÅŸvurunuz baÅŸarÄ±yla gÃ¶nderildi! Adminler deÄŸerlendirecek.");
            form.reset();
        }catch(err){console.error(err);showModal("Hata","BaÅŸvurunuz gÃ¶nderilirken hata oluÅŸtu.");}
    });
}

function renderAdminPanel(){
    let tableRows=applications.map(app=>`
        <tr class="border-b border-gray-700 hover:bg-gray-600 transition-colors">
            <td class="px-4 py-2">${app.name}</td>
            <td class="px-4 py-2">${app.age}</td>
            <td class="px-4 py-2">${app.status}</td>
            <td class="px-4 py-2">${app.rejectionReason||'â€”'}</td>
            <td class="px-4 py-2">${new Date(app.timestamp?.seconds*1000).toLocaleString('tr-TR')}</td>
            <td class="px-4 py-2">${app.responseTimestamp?new Date(app.responseTimestamp.seconds*1000).toLocaleString('tr-TR'):'â€”'}</td>
            <td class="px-4 py-2">
                <button class="btn-primary py-1 px-2 mr-2" onclick="updateApplicationStatus('${app.id}','Approved')">Onayla</button>
                <button class="btn-primary py-1 px-2 bg-red-600 hover:bg-red-500" onclick="updateApplicationStatus('${app.id}','Rejected')">Reddet</button>
            </td>
        </tr>`).join('');

    contentAreaEl.innerHTML=`
    <div class="card p-6 sm:p-8 max-w-5xl mx-auto shadow-lg hover:shadow-xl transition-all duration-300">
        <h2 class="text-3xl font-extrabold mb-6 text-indigo-400">Admin Paneli</h2>
        <button id="toggle-recruitment" class="btn-primary mb-6 hover:bg-indigo-500 transition-colors">Yetkili AlÄ±mÄ± AÃ§/Kapat</button>
        <div class="overflow-x-auto">
            <table class="min-w-full border border-gray-700 divide-y divide-gray-700 text-left text-gray-300">
                <thead class="bg-gray-800">
                    <tr>
                        <th class="px-4 py-2">Ad / KullanÄ±cÄ±</th>
                        <th class="px-4 py-2">YaÅŸ</th>
                        <th class="px-4 py-2">Durum</th>
                        <th class="px-4 py-2">Redd. Nedeni</th>
                        <th class="px-4 py-2">BaÅŸvurma Tarihi</th>
                        <th class="px-4 py-2">Cevap Tarihi</th>
                        <th class="px-4 py-2">Ä°ÅŸlem</th>
                    </tr>
                </thead>
                <tbody>${tableRows}</tbody>
            </table>
        </div>
    </div>`;

    document.getElementById('toggle-recruitment').addEventListener('click',async ()=>{
        try{
            await updateDoc(CONFIG_DOC_PATH(),{recruitmentOpen:!isRecruitmentOpen});
            showModal("BaÅŸarÄ±lÄ±",`Yetkili alÄ±mÄ± ${!isRecruitmentOpen?'AÃ‡ILDI':'KAPATILDI'}`);
        }catch(err){console.error(err);showModal("Hata","AlÄ±m durumunu gÃ¼ncellerken hata oluÅŸtu.");}
    });
}

window.updateApplicationStatus=async function(appId,newStatus){
    try{
        const updateData={status:newStatus,responseTimestamp:serverTimestamp()};
        if(newStatus==='Rejected'){
            const reason=prompt("Reddetme nedeni girin:")||'â€”';
            updateData.rejectionReason=reason;
        }
        await updateDoc(doc(db,APPLICATIONS_COLLECTION().path,appId),updateData);
        showModal("BaÅŸarÄ±lÄ±",`BaÅŸvuru durumu "${newStatus}" olarak gÃ¼ncellendi.`);
    }catch(err){console.error(err);showModal("Hata","BaÅŸvuru durumunu gÃ¼ncellerken hata oluÅŸtu.");}
}

initAuth();
</script>
</body>
</html>